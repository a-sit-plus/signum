name: Test Manually (Matrix Entry)

on:
  workflow_dispatch:
    inputs:
      entry-name:
        description: "Matrix entry name from .github/test-strategy-matrix.json (e.g., iosRunner, appleOtherRunner, jvmRunner)"
        required: true
        default: "jvmRunner"
        type: string
      kotlin-version:
        description: "Override Kotlin version?"
        required: false
        default: ""
        type: string
      testballoon-version:
        description: "Override TestBalloon version (full version string)?"
        required: false
        default: ""
        type: string

jobs:
  select-entry:
    runs-on: ubuntu-latest
    outputs:
      os: ${{ steps.pick.outputs.os }}
      arch: ${{ steps.pick.outputs.arch }}
      testArgs: ${{ steps.pick.outputs.testArgs }}
      enableKvm: ${{ steps.pick.outputs.enableKvm }}
      xcodeVersion: ${{ steps.pick.outputs.xcodeVersion }}
    steps:
      - uses: actions/checkout@v4
      - id: pick
        uses: actions/github-script@v7
        env:
          ENTRY_NAME: ${{ inputs.entry-name }}
        with:
          script: |
            const fs = require('fs');
            const entryName = process.env.ENTRY_NAME;
            if (!entryName) {
              core.setFailed('Missing entry-name input');
              return;
            }
            const matrix = JSON.parse(fs.readFileSync('.github/test-strategy-matrix.json', 'utf8'));
            const entry = (matrix.include || []).find(e => e.name === entryName);
            if (!entry) {
              core.setFailed(`No matrix entry named "${entryName}"`);
              return;
            }
            core.setOutput('os', entry.os || '');
            core.setOutput('arch', entry.arch || '');
            core.setOutput('testArgs', entry.testArgs || '');
            core.setOutput('enableKvm', entry.enableKvm ? 'true' : 'false');
            core.setOutput('xcodeVersion', entry.xcodeVersion || '');

  test:
    needs: select-entry
    uses: a-sit-plus/internal-workflows/.github/workflows/test-matrix-entry.yml@feature/modularTests
    with:
      override-cache: ${{ github.ref_name == 'development' || github.ref_name == 'main' }}
      os: ${{ needs.select-entry.outputs.os }}
      name: ${{ inputs.entry-name }}
      arch: ${{ needs.select-entry.outputs.arch }}
      testArgs: ${{ needs.select-entry.outputs.testArgs }}
      enable-kvm: ${{ needs.select-entry.outputs.enableKvm == 'true' }}
      xcode-version: ${{ needs.select-entry.outputs.xcodeVersion }}
      kotlin-version: ${{ inputs.kotlin-version }}
      testballoon-version: ${{ inputs.testballoon-version }}
