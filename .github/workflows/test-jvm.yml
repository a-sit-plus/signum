name: Test JVM
on:
  # still run checks on every PR *before* the merge
  pull_request:

  # run the workflow once more **after** the PR has been merged
  push:
    branches:
      - main
      - development

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 120
    steps:
      - name: Checkout (default)
        if: github.event_name != 'pull_request'
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          submodules: recursive

      # For pull_request_target, explicitly fetch the PR head
      - name: Checkout PR head (for pull_request)
        if: github.event_name == 'pull_request'
        uses: actions/checkout@v4
        with:
          repository: ${{ github.event.pull_request.head.repo.full_name }}
          ref: ${{ github.event.pull_request.head.sha }}
          fetch-depth: 0
          submodules: recursive

      - uses: actions/setup-java@v3
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Run tests
        run: ./gradlew jvmTest

      # --- Per-module artifacts ---
      - name: Upload results (indispensable-asn1)
        if: success() || failure()
        uses: actions/upload-artifact@v4
        with:
          name: test-results-indispensable-asn1
          path: indispensable-asn1/build/test-results/**/TEST*.xml
          if-no-files-found: ignore

      - name: Upload results (indispensable-oids)
        if: success() || failure()
        uses: actions/upload-artifact@v4
        with:
          name: test-results-indispensable-oids
          path: indispensable-oids/build/test-results/**/TEST*.xml
          if-no-files-found: ignore

      - name: Upload results (indispensable)
        if: success() || failure()
        uses: actions/upload-artifact@v4
        with:
          name: test-results-indispensable
          path: indispensable/build/test-results/**/TEST*.xml
          if-no-files-found: ignore

      - name: Upload results (indispensable-josef)
        if: success() || failure()
        uses: actions/upload-artifact@v4
        with:
          name: test-results-indispensable-josef
          path: indispensable-josef/build/test-results/**/TEST*.xml
          if-no-files-found: ignore

      - name: Upload results (indispensable-cosef)
        if: success() || failure()
        uses: actions/upload-artifact@v4
        with:
          name: test-results-indispensable-cosef
          path: indispensable-cosef/build/test-results/**/TEST*.xml
          if-no-files-found: ignore

      - name: Upload results (supreme)
        if: success() || failure()
        uses: actions/upload-artifact@v4
        with:
          name: test-results-supreme
          path: supreme/build/test-results/**/TEST*.xml
          if-no-files-found: ignore

      # --- Single reporter step that renders a section per artifact ---
      - name: Test Report (per module)
        if: success() || failure()
        uses: dorny/test-reporter@v2
        env:
          # keep memory headroom; adjust as you like
          NODE_OPTIONS: --max-old-space-size=16384
        with:
          artifact: /test-results-(.*)/   # regex over artifact names
          name: JVM — $1                  # e.g. "JVM — indispensable-asn1"
          report-title: $1                # section title = module name
          path: '*.xml'                   # inside each artifact archive
          reporter: java-junit
          # full details as requested:
          list-suites: all
          list-tests: all
          # avoid excessive API load while keeping full summary content:
          max-annotations: 50
          use-actions-summary: true
